def postGisImage = 'postgis/postgis:11-2.5-alpine'
def schemaBase = [
	'java', '-jar', '/home/bjsvwjek/tools/ili2pg-4.3.1/ili2pg-4.3.1.jar',
	'--schemaimport', 
	'--dbdatabase', 'postgres',
	'--dbusr', 'postgres',
	'--dbpwd', 'postgres',
	'--modeldir', '%ILI_FROM_DB;http://models.interlis.ch/;' + projectDir.toString() + '/ili'
]

task dbEmpty(type:Exec){
    commandLine 'docker', 'run', '-e', 'POSTGRES_PASSWORD=postgres', '--network', 'host', postGisImage
    ignoreExitValue true

    doLast {
        sleep(5000)
    }
}

task ext0(type:Exec){
	commandLine = schemaBase.clone() + [
				'--dbschema', 'ext0',
				'--models', 'CH_SoSrBase',
				projectDir.toString() + '/ili/ExtensionChain.ili'
	]
}

task ext1(type:Exec, dependsOn:ext0){
	commandLine	= schemaBase.clone() + [
				'--dbschema', 'ext1',
				'--models', 'SO_SrExtended',
				projectDir.toString() + '/ili/ExtensionChain.ili'
	]
}

task ext2(type:Exec, dependsOn:ext1){
	commandLine	= schemaBase.clone() + [
			'--dbschema', 'ext2',
			'--models', 'SO_SrExtended2',
			projectDir.toString() + '/ili/ExtensionChain.ili'
	]
}

task extended {
	dependsOn {[ext0, ext1, ext2]}
}

task attrTypes(type:Exec){
	commandLine	= schemaBase.clone() + [
			'--dbschema', 'attr_types',
			'--models', 'SO_SrAttrTypes',
			'--preScript', projectDir.toString() + '/ili/SO_SrAttrTypes_Pre.sql',
			projectDir.toString() + '/ili/SO_SrAttrTypes.ili'
	]
}

task comments(type:Exec){
	commandLine	= schemaBase.clone() + [
			'--dbschema', 'comments',
			'--models', 'SO_SrComments',
			projectDir.toString() + '/ili/SO_SrComments.ili'
	]
}

task pkey(type:Exec){
	commandLine	= schemaBase.clone() + [
			'--dbschema', 'pkey',
			'--models', 'SO_SrPrimaryKey',
			'--postScript', projectDir.toString() + '/ili/SO_SrPrimaryKey_Post.sql',
			projectDir.toString() + '/ili/SO_SrPrimaryKey.ili'
	]
}

task geo(type:Exec){
	commandLine	= schemaBase.clone() + [
			'--dbschema', 'geo',
			'--models', 'SO_SrGeo',
			projectDir.toString() + '/ili/SO_SrGeo.ili'
	]
}


task ddl{
	dependsOn {[extended, attrTypes, comments, pkey, geo]}

	mustRunAfter dbEmpty
}


task dbDdl{
	dependsOn {[dbEmpty, ddl]}
}




/*
String getTravisBuildNumber() {
	String val = System.getenv('TRAVIS_BUILD_NUMBER')

	if(val == null)
		val = 'localbuild'

	return val
}

def getCheckedOutGitCommitHash() {
  'git log -1 --pretty=%H'.execute().text.trim()
}

def getTimestamp() {
    def date = new Date()
    return date.format('yyyy-MM-dd HH:mm:ss')
}
*/